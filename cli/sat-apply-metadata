#!/usr/bin/env python3
import sys
from pathlib import Path
import yaml

# Allow imports from repo root
REPO_ROOT = Path(__file__).resolve().parents[2]
sys.path.insert(0, str(REPO_ROOT))

from tools.core.plugin_loader import load_plugin, load_plugin_config  # type: ignore


def load_front_matter(path: Path):
    text = path.read_text(encoding="utf-8")
    if not text.startswith("---"):
        return {}, text

    parts = text.split("---", 2)
    if len(parts) < 3:
        return {}, text

    _, yaml_block, rest = parts
    metadata = yaml.safe_load(yaml_block) or {}
    content = rest.lstrip("\n")
    return metadata, content


def write_front_matter(path: Path, metadata, content: str):
    yaml_block = yaml.safe_dump(metadata, sort_keys=False).strip()
    text = f"---\n{yaml_block}\n---\n\n{content}"
    path.write_text(text, encoding="utf-8")


def main():
    if len(sys.argv) < 2:
        print("Usage: sat-apply-metadata <path> [--plugin <plugin-id>]")
        sys.exit(1)

    target = Path(sys.argv[1])
    plugin_id = "metadata.dublin-core"

    if "--plugin" in sys.argv:
        idx = sys.argv.index("--plugin")
        if idx + 1 < len(sys.argv):
            plugin_id = sys.argv[idx + 1]

    if not target.exists():
        print(f"Error: {target} does not exist")
        sys.exit(1)

    plugin_info = load_plugin(plugin_id)
    config = load_plugin_config(plugin_info)
    apply_fn = plugin_info["callable"]

    metadata, content = load_front_matter(target)
    updated = apply_fn(metadata, config)

    write_front_matter(target, updated, content)

    print(f"Metadata updated using plugin {plugin_id} for {target}")


if __name__ == "__main__":
    main()
